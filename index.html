<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Pro | Ultimate Secure Chat</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        :root { --primary: #6366f1; --accent: #00d2ff; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); font-family: 'Outfit', sans-serif; margin: 0; height: 100vh; overflow: hidden; color: white; }

        /* --- BEAUTIFUL ANIMATED LOGIN --- */
        #authLayer { 
            position: fixed; inset: 0; z-index: 9000; 
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #1e1b4b);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }
        
        .auth-card { 
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px);
            padding: 40px 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1);
            width: 100%; max-width: 380px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .auth-card h1 { font-family: 'Orbitron'; font-size: 2.2rem; color: var(--accent); margin: 0; letter-spacing: 3px; text-shadow: 0 0 15px var(--accent); }
        .auth-card input { 
            width: 100%; padding: 15px; margin: 10px 0; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; color: white; font-size: 1rem;
        }
        .btn-main { 
            width: 100%; padding: 15px; background: var(--primary); color: white; border: none; 
            border-radius: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.3s;
        }

        /* --- APP HEADER --- */
        header { 
            padding: 15px 20px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .status-container { display: flex; align-items: center; gap: 10px; }
        .pfp-orbit { 
            width: 45px; height: 45px; border-radius: 50%; position: relative; 
            padding: 2px; border: 2px solid transparent; transition: 0.5s;
        }
        .pfp-orbit img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .is-online .pfp-orbit { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); animation: rotateOrbit 3s linear infinite; }
        @keyframes rotateOrbit { 0% { border-top-color: var(--accent); } 50% { border-right-color: var(--accent); } 100% { border-top-color: var(--accent); } }

        /* --- POPUP USER LIST --- */
        #userModal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 8000; 
            display: none; flex-direction: column; padding: 30px 20px; animation: zoomIn 0.3s ease;
        }
        .user-card { 
            background: var(--glass); padding: 15px; border-radius: 20px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(255,255,255,0.05);
        }

        /* --- CHAT DISPLAY & UNIQUE SEEN --- */
        #chatDisplay { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg { 
            max-width: 75%; padding: 12px 16px; border-radius: 20px; position: relative;
            font-size: 0.95rem; animation: msgSlide 0.3s ease;
        }
        @keyframes msgSlide { from { transform: translateY(10px); opacity:0; } to { transform: translateY(0); opacity:1; } }
        .msg-me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-them { align-self: flex-start; background: var(--glass); border-bottom-left-radius: 2px; }
        
        /* Unique Seen Glow */
        .msg.seen-glow { box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); border: 1px solid var(--accent); }

        /* --- REDESIGNED TYPING --- */
        .typing-pill { 
            position: fixed; bottom: 85px; left: 20px; background: var(--primary);
            padding: 8px 15px; border-radius: 20px; display: none; align-items: center; gap: 5px;
        }
        .dot { width: 6px; height: 6px; background: white; border-radius: 50%; animation: jump 1.4s infinite ease-in-out; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes jump { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- INPUT AREA --- */
        .bottom-bar { padding: 15px; background: rgba(15, 23, 42, 0.9); border-top: 1px solid rgba(255,255,255,0.05); }
        .input-wrap { display: flex; align-items: center; gap: 12px; }
        #msgInput { 
            flex: 1; padding: 15px 20px; border-radius: 25px; border: none; 
            background: var(--glass); color: white; font-size: 1rem;
        }
        .btn-circle { width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        /* --- SAFE TERMS POPUP --- */
        #termsModal { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; padding: 20px; }
        .safe-box { background: #1e293b; padding: 30px; border-radius: 25px; max-width: 400px; text-align: left; border: 1px solid var(--accent); }
        .safe-box h2 { color: var(--accent); margin-top: 0; }
        .safe-box ul { padding-left: 20px; color: #cbd5e1; font-size: 0.9rem; }
        .safe-box li { margin-bottom: 10px; }

        /* Double Tap Animation */
        .reply-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="authLayer">
        <div class="auth-card">
            <h1>NEON PRO</h1>
            <p style="color:#94a3b8; margin: 15px 0 25px 0;">The future of private chatting.</p>
            <input type="text" id="uName" placeholder="Username">
            <input type="password" id="uPass" placeholder="Password">
            <p style="font-size: 0.75rem; color: #64748b; cursor: pointer; text-decoration: underline;" onclick="toggleScreen('termsModal')">Safety & Security Terms</p>
            <button class="btn-main" onclick="startLogin()">GET STARTED</button>
        </div>
    </div>

    <div id="termsModal" style="display:none;">
        <div class="safe-box">
            <h2>üõ°Ô∏è Your Safety First</h2>
            <ul>
                <li><b>No Logs:</b> We never store your real-time messages after delivery.</li>
                <li><b>Hashed Passwords:</b> Even we cannot see your password.</li>
                <li><b>E2EE Active:</b> All chats are automatically encrypted with AES-256.</li>
                <li><b>Hardware Ban:</b> Abusive users are banned by Device ID & IP.</li>
            </ul>
            <button class="btn-main" onclick="toggleScreen('termsModal')">I FEEL SAFE NOW</button>
        </div>
    </div>

    <div id="appLayer" style="display:none; flex-direction:column; height:100vh;">
        <header>
            <div class="status-container" id="myStatusBox">
                <div class="pfp-orbit"><img id="myPfp" src="https://api.dicebear.com/7.x/avataaars/svg?seed=me" onclick="document.getElementById('pfpInput').click()"></div>
                <div><div style="font-size:0.8rem; font-weight:600;">Me</div><div style="font-size:0.6rem; color:var(--accent);">Active</div></div>
            </div>

            <div style="text-align:center;"><i class="fas fa-shield-halved" style="color:var(--accent); font-size:1.2rem;"></i><div style="font-size:0.5rem; letter-spacing:1px; opacity:0.5;">ENCRYPTED</div></div>

            <div class="status-container" id="partnerStatusBox">
                <div style="text-align:right;"><div id="partnerName" style="font-size:0.8rem; font-weight:600;">Partner</div><div id="pStatusText" style="font-size:0.6rem; color:#64748b;">Offline</div></div>
                <div class="pfp-orbit"><img id="partnerPfp" src="https://api.dicebear.com/7.x/avataaars/svg?seed=p"></div>
            </div>
        </header>

        <div style="height:50px; background:#000; display:flex; justify-content:center; align-items:center; border-bottom:1px solid #1e293b;">
             <script type="text/javascript">atOptions = {'key' : '697d465f55b34630746380bf6791eb54','format' : 'iframe','height' : 50,'width' : 320,'params' : {}};</script>
             <script type="text/javascript" src="https://www.highperformanceformat.com/697d465f55b34630746380bf6791eb54/invoke.js"></script>
        </div>

        <div id="chatDisplay"></div>

        <div class="typing-pill" id="typingBox">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>

        <div id="replyBar" style="display:none; background:rgba(255,255,255,0.05); padding:10px 20px; border-left:4px solid var(--accent);">
            <div style="font-size:0.7rem; color:var(--accent);" id="replyUser">Replying to...</div>
            <div id="replyTxt" style="font-size:0.8rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
        </div>

        <div class="bottom-bar">
            <div class="input-wrap">
                <button class="btn-circle" onclick="toggleScreen('userModal')" style="background:var(--glass);"><i class="fas fa-users"></i></button>
                <input type="file" id="pfpInput" hidden onchange="uploadPFP(this)">
                <input type="text" id="msgInput" placeholder="Message..." enterkeyhint="send" oninput="handleTyping()">
                <button class="btn-circle" onclick="sendTxt()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="userModal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="font-family:'Orbitron';">Discovery</h2>
            <i class="fas fa-times" onclick="toggleScreen('userModal')" style="font-size:1.5rem;"></i>
        </div>
        <input type="text" id="searchInp" style="width:100%; padding:15px; border-radius:15px; background:var(--glass); border:none; color:white; margin-bottom:20px;" placeholder="Search by name..." oninput="doSearch(this.value)">
        <div id="userList" style="flex:1; overflow-y:auto;"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANEPedAQAd9VYnMMdw42Bjw_tQkBxxn2M",
            authDomain: "neon-game-hub.firebaseapp.com",
            databaseURL: "https://neon-game-hub-default-rtdb.firebaseio.com",
            projectId: "neon-game-hub",
            storageBucket: "neon-game-hub.firebasestorage.app",
            messagingSenderId: "636141968933",
            appId: "1:636141968933:web:60c7cc21d75883ef08a9cc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const APP_SECRET = "NEON_AUTO_SECURE_2026_X";

        let myName, partner, chatId, replyData = null;

        // --- 1. SESSION & LOGIN ---
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('currentUser');
            if(saved) { myName = saved; loginOK(); }
            
            document.getElementById('msgInput').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') sendTxt();
            });
        });

        function loginOK() {
            document.getElementById('authLayer').style.display = 'none';
            document.getElementById('appLayer').style.display = 'flex';
            
            // Manage Online Status
            const myStatusRef = db.ref('status/' + myName);
            myStatusRef.set('online');
            myStatusRef.onDisconnect().set(Date.now());

            // Load My PFP
            db.ref('users/' + myName + '/pfp').on('value', s => {
                if(s.val()) document.getElementById('myPfp').src = s.val();
            });

            // Monitor Me (Orbit Glow)
            document.getElementById('myStatusBox').classList.add('is-online');
        }

        function startLogin() {
            myName = document.getElementById('uName').value.trim().toLowerCase();
            const p = document.getElementById('uPass').value.trim();
            if(!myName || !p) return alert("Fill all details!");
            const hp = CryptoJS.SHA256(p).toString();
            db.ref('users/' + myName).once('value', s => {
                if(s.exists() && s.val().pass !== hp) return alert("Wrong password");
                if(!s.exists()) db.ref('users/' + myName).set({ pass: hp });
                localStorage.setItem('currentUser', myName);
                loginOK();
            });
        }

        // --- 2. USER DISCOVERY & PARTNER ---
        function doSearch(q) {
            const list = document.getElementById('userList'); list.innerHTML = "";
            db.ref('users').once('value', s => {
                s.forEach(u => {
                    if(u.key.includes(q) && u.key !== myName) {
                        list.innerHTML += `
                            <div class="user-card" onclick="selectPartner('${u.key}')">
                                <b>${u.key.toUpperCase()}</b>
                                <button class="btn-main" style="width:80px; margin:0; padding:8px;">CHAT</button>
                            </div>
                        `;
                    }
                });
            });
        }

        function selectPartner(name) {
            partner = name;
            chatId = [myName, partner].sort().join("_");
            document.getElementById('partnerName').innerText = partner.toUpperCase();
            toggleScreen('userModal');

            // Sync Partner Status & PFP
            db.ref('users/' + partner + '/pfp').on('value', s => {
                document.getElementById('partnerPfp').src = s.val() || `https://api.dicebear.com/7.x/avataaars/svg?seed=${partner}`;
            });

            db.ref('status/' + partner).on('value', s => {
                const st = s.val();
                const box = document.getElementById('partnerStatusBox');
                const text = document.getElementById('pStatusText');
                if(st === 'online') {
                    box.classList.add('is-online'); text.innerText = "Active"; text.style.color = "var(--accent)";
                } else {
                    box.classList.remove('is-online');
                    const lastSeen = st ? new Date(st).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:true}) : "---";
                    text.innerText = "Last seen " + lastSeen; text.style.color = "#64748b";
                }
            });

            // Sync Typing
            db.ref('typing/' + chatId + '/' + partner).on('value', s => {
                document.getElementById('typingBox').style.display = s.val() ? 'flex' : 'none';
            });

            loadChat();
        }

        // --- 3. CHAT LOGIC ---
        function loadChat() {
            const box = document.getElementById('chatDisplay');
            db.ref('chats/' + chatId).limitToLast(30).on('value', s => {
                box.innerHTML = `<div style="text-align:center; opacity:0.3; font-size:0.6rem; margin-top:20px;"><i class="fas fa-lock"></i> END-TO-END ENCRYPTED CHAT</div>`;
                s.forEach(m => {
                    const dat = m.val();
                    const isMe = dat.from === myName;
                    const d = document.createElement('div');
                    d.className = `msg ${isMe ? 'msg-me' : 'msg-them'} ${(isMe && dat.seen) ? 'seen-glow' : ''}`;
                    
                    // Seen Logic
                    if(!isMe && !dat.seen) db.ref('chats/' + chatId + '/' + m.key + '/seen').set(true);

                    // Double Tap Animation & Reply
                    let lastTap = 0;
                    d.onclick = () => {
                        let cur = new Date().getTime();
                        if(cur - lastTap < 300) {
                            d.classList.add('reply-pop');
                            setTimeout(()=>d.classList.remove('reply-pop'), 400);
                            replyData = { text: decrypt(dat.val), from: dat.from };
                            document.getElementById('replyBar').style.display = 'block';
                            document.getElementById('replyUser').innerText = "Replying to " + dat.from;
                            document.getElementById('replyTxt').innerText = replyData.text;
                        }
                        lastTap = cur;
                    };

                    let html = "";
                    if(dat.reply) html += `<div style="font-size:0.7rem; opacity:0.6; border-left:2px solid #fff; padding-left:8px; margin-bottom:5px;"><b>${dat.reply.from}</b>: ${dat.reply.text}</div>`;
                    html += `<div>${decrypt(dat.val)}</div>`;
                    d.innerHTML = html;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function sendTxt() {
            const inp = document.getElementById('msgInput');
            const val = inp.value.trim();
            if(!val || !chatId) return;

            const msg = { from: myName, val: encrypt(val), time: Date.now(), seen: false };
            if(replyData) { msg.reply = replyData; cancelReply(); }
            
            db.ref('chats/' + chatId).push(msg);
            inp.value = ""; inp.focus();
            db.ref('typing/' + chatId + '/' + myName).set(false);
        }

        // --- 4. EXTRAS ---
        function encrypt(t) { return CryptoJS.AES.encrypt(t, APP_SECRET).toString(); }
        function decrypt(c) { try { return CryptoJS.AES.decrypt(c, APP_SECRET).toString(CryptoJS.enc.Utf8); } catch(e) { return ""; } }
        
        function handleTyping() {
            if(!chatId) return;
            db.ref('typing/' + chatId + '/' + myName).set(true);
            clearTimeout(window.tOut);
            window.tOut = setTimeout(()=> db.ref('typing/' + chatId + '/' + myName).set(false), 2000);
        }

        function uploadPFP(inp) {
            const r = new FileReader();
            r.onload = (e) => db.ref('users/' + myName + '/pfp').set(e.target.result);
            r.readAsDataURL(inp.files[0]);
        }

        function toggleScreen(id) {
            const e = document.getElementById(id);
            e.style.display = (e.style.display === 'none' || e.style.display === '') ? 'flex' : 'none';
        }

        function cancelReply() { replyData = null; document.getElementById('replyBar').style.display = 'none'; }
        function logout() { localStorage.removeItem('currentUser'); location.reload(); }
    </script>
</body>
</html>
