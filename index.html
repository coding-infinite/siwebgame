<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Reflex: Real Sync</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --success: #28a745; --danger: #d9534f; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #333; font-family: 'Poppins', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* SCOREBOARD */
        #scoreboard { width: 100%; height: 75px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100; position: absolute; top: 0; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary); background: #eee; object-fit: cover; }
        .player-info { display: flex; flex-direction: column; align-items: center; width: 80px; }
        .score-val { font-weight: bold; font-size: 1.3rem; margin-top: 2px; }
        .player-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }

        /* MENU */
        .center-container { flex: 1; display: flex; justify-content: center; align-items: center; padding-bottom: 50px; margin-top: 70px; }
        .card { background: white; border-radius: 20px; padding: 25px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { font-family: 'Orbitron'; color: #222; margin: 0; font-size: 1.8rem; }
        #qrcode { margin: 15px auto; display: flex; justify-content: center; }
        
        .btn { width: 100%; padding: 12px; margin: 6px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-share { background: #25D366; color: white; margin-top: 5px; }

        input { width: 100%; padding: 10px; background: #f1f3f5; border: 1px solid #ddd; color: #333; border-radius: 8px; text-align: center; font-size: 1.1rem; margin-bottom: 8px; font-family: 'Orbitron'; }

        /* GAME AREA */
        #gameArea { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 50; }
        .status-text { font-family: 'Orbitron'; font-size: 3.5rem; text-align: center; pointer-events: none; user-select: none; }
        
        .bg-waiting { background: #fff; } 
        .bg-go { background: var(--success); }
        .bg-win { background: var(--primary); } 
        .bg-lose { background: var(--danger); }
        
        .text-white { color: white !important; }
        .text-dark { color: #333 !important; }

        /* FINAL SCREEN */
        #finalScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 300; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .hidden { display: none !important; }

        /* AD BAR */
        #ad-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; border-top: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="scoreboard" class="hidden">
        <div class="player-info">
            <img id="p1Avatar" class="avatar" src="">
            <div id="scoreP1" class="score-val">0</div>
            <div id="p1Label" class="player-label">HOST</div>
        </div>
        <div style="text-align:center">
            <div id="roundDisplay" style="font-family:Orbitron; font-size:1.5rem; color:#888">1/5</div>
        </div>
        <div class="player-info">
            <img id="p2Avatar" class="avatar" src="">
            <div id="scoreP2" class="score-val">0</div>
            <div id="p2Label" class="player-label">GUEST</div>
        </div>
    </div>

    <div id="lobby" class="center-container">
        <div class="card">
            <h1>NEON REFLEX</h1>
            <p>Server Sync Edition</p>
            <div id="mainMenu">
                <button class="btn btn-primary" onclick="createRoom()">CREATE ROOM</button>
                <input type="text" id="roomInput" placeholder="ENTER CODE">
                <button class="btn btn-outline" onclick="joinRoom()">JOIN ROOM</button>
                <button class="btn" style="background:#f1f3f5; color:#666; margin-top:10px" onclick="startLocalGame()">ðŸ¤– PRACTICE VS AI</button>
            </div>
            <div id="waitingUi" class="hidden">
                <div id="qrcode"></div>
                <h2 id="roomCodeDisplay" style="color:var(--primary); font-size:2.5rem; margin:10px 0;"></h2>
                <div style="color:#888;">Waiting for player...</div>
                <button class="btn" style="background:#eee; margin-top:15px" onclick="location.reload()">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="gameArea" class="bg-waiting" ontouchstart="handleTap()" onclick="handleTap()">
        <div id="gameMessage" class="status-text text-dark">WAIT</div>
    </div>

    <div id="finalScreen">
        <img id="resultAvatar" class="avatar" style="width:90px; height:90px; border-width:4px;">
        <h1 id="finalTitle" style="margin-top:10px; font-size:2rem;"></h1>
        <p id="finalScoreText" style="font-size:1.2rem; font-weight:bold; margin:10px 0;"></p>
        <button id="shareBtn" class="btn btn-share">SHARE SCORE ðŸ’š</button>
        <button class="btn" style="background:#eee" onclick="location.reload()">MAIN MENU</button>
    </div>

    <div id="ad-container">
        <script type="text/javascript">
            atOptions = { 'key' : '697d465f55b34630746380bf6791eb54', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="https://www.highperformanceformat.com/697d465f55b34630746380bf6791eb54/invoke.js"></script>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANEPedAQAd9VYnMMdw42Bjw_tQkBxxn2M",
            authDomain: "neon-game-hub.firebaseapp.com",
            databaseURL: "https://neon-game-hub-default-rtdb.firebaseio.com",
            projectId: "neon-game-hub",
            storageBucket: "neon-game-hub.firebasestorage.app",
            messagingSenderId: "636141968933",
            appId: "1:636141968933:web:60c7cc21d75883ef08a9cc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. UNIQUE ID EVERY TIME (Fixes "Both Win" bug on same browser)
        let myId = "player_" + Math.random().toString(36).substr(2, 9);
        let myAvatar = `https://api.dicebear.com/7.x/bottts/svg?seed=${myId}`;
        
        let roomId = null, role = null; // 'host' or 'guest'
        let state = "lobby"; 
        let currentRound = 1, canTap = false;
        let p1Score = 0, p2Score = 0; // Server Synced Scores
        let gameMode = "online";

        // --- ROOM LOGIC ---
        function createRoom() {
            gameMode = "online";
            role = "host";
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            
            const joinUrl = window.location.href.split('?')[0] + "?room=" + roomId;
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: joinUrl, width: 120, height: 120 });
            
            // Initialize Server State
            db.ref('reflex/' + roomId).set({ 
                status: "waiting", 
                hostAvatar: myAvatar,
                scores: { p1: 0, p2: 0 }, // Score is on server now
                round: 1
            });
            
            document.getElementById('p1Avatar').src = myAvatar;
            document.getElementById('p1Label').innerText = "YOU (HOST)";
            document.getElementById('p2Label').innerText = "OPPONENT";
            
            showWaiting();
            
            // Wait for guest
            const listener = db.ref('reflex/' + roomId).on('value', snap => {
                const data = snap.val();
                if (data && data.status === "ready") {
                    db.ref('reflex/' + roomId).off('value', listener);
                    document.getElementById('p2Avatar').src = data.guestAvatar;
                    startGame();
                }
            });
        }

        function joinRoom() {
            gameMode = "online";
            role = "guest";
            roomId = document.getElementById('roomInput').value.toUpperCase().trim();
            if (!roomId) return alert("Code Empty!");

            db.ref('reflex/' + roomId).once('value', snap => {
                if (snap.exists()) {
                    const data = snap.val();
                    document.getElementById('p1Avatar').src = data.hostAvatar;
                    document.getElementById('p2Avatar').src = myAvatar;
                    document.getElementById('p2Label').innerText = "YOU (GUEST)";
                    document.getElementById('p1Label').innerText = "OPPONENT";
                    
                    db.ref('reflex/' + roomId).update({ status: "ready", guestAvatar: myAvatar });
                    startGame();
                } else alert("Invalid Code!");
            });
        }

        // --- GAME FLOW ---
        function startGame() {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('waitingUi').classList.add('hidden');
            document.getElementById('gameArea').style.display = 'flex';
            document.getElementById('scoreboard').classList.remove('hidden');
            document.getElementById('finalScreen').style.display = 'none';

            if(gameMode === "online") {
                startOnlineListener();
                if (role === "host") setTimeout(hostStartRound, 1500);
            } else {
                startLocalGame();
            }
        }

        // --- ONLINE LISTENER ---
        function startOnlineListener() {
            db.ref('reflex/' + roomId).on('value', snap => {
                const data = snap.val();
                if (!data) return;

                // Sync Scores from Server (Source of Truth)
                p1Score = data.scores.p1;
                p2Score = data.scores.p2;
                updateScoreUI();

                // State Machine
                if (data.status === "wait") {
                    setScreen("wait");
                    currentRound = data.round;
                } 
                else if (data.status === "go") {
                    if (state !== "go" && state !== "end") {
                        setScreen("go");
                        window.goTime = data.goTime;
                    }
                }
                else if (data.status === "round_end") {
                    // Logic to show win/loss based on who server says won
                    let winnerRole = data.winnerRole; // 'p1' or 'p2'
                    let iWon = (role === "host" && winnerRole === "p1") || (role === "guest" && winnerRole === "p2");
                    
                    if(state !== "end") {
                        setScreen(iWon ? "win" : "lose");
                        // Host triggers next round logic after delay
                        if (role === "host" && currentRound < 5) {
                            setTimeout(hostStartRound, 3000);
                        } else if (role === "host" && currentRound >= 5) {
                            setTimeout(() => db.ref('reflex/' + roomId).update({ status: "game_over" }), 3000);
                        }
                    }
                }
                else if (data.status === "game_over") {
                    showFinalScreen();
                }
            });
        }

        function hostStartRound() {
            if (currentRound > 5) return;
            // Reset for next round
            db.ref('reflex/' + roomId).update({ 
                status: "wait", 
                round: currentRound 
            });
            
            const delay = Math.random() * 2000 + 2000;
            setTimeout(() => {
                db.ref('reflex/' + roomId).update({ status: "go", goTime: Date.now() });
            }, delay);
        }

        function handleTap() {
            if (state === "end" || state === "lobby" || !canTap) return;
            canTap = false; // Lock local tap

            if (gameMode === "local") { localHandleTap(); return; }

            if (state === "go") {
                // Claim win
                let myRole = (role === "host") ? "p1" : "p2";
                
                // Transaction to ensure only first tap counts
                db.ref('reflex/' + roomId).transaction(curr => {
                    if (curr && curr.status === "go") {
                        // Increment Score on Server
                        if (myRole === "p1") curr.scores.p1++;
                        else curr.scores.p2++;
                        
                        curr.status = "round_end";
                        curr.winnerRole = myRole;
                        curr.round++; // Prepare next round number
                        return curr;
                    }
                    return; // Abort if already won
                });
            } 
            else if (state === "wait") {
                // Early Tap Penalty (Opponent Wins)
                let oppRole = (role === "host") ? "p2" : "p1";
                
                 db.ref('reflex/' + roomId).transaction(curr => {
                    if (curr && curr.status === "wait") {
                        if (oppRole === "p1") curr.scores.p1++;
                        else curr.scores.p2++;

                        curr.status = "round_end";
                        curr.winnerRole = oppRole;
                        curr.round++;
                        return curr;
                    }
                     return;
                 });
            }
        }

        // --- LOCAL AI ---
        function startLocalGame() {
            gameMode = "local";
            document.getElementById('p1Avatar').src = myAvatar;
            document.getElementById('p2Avatar').src = "https://api.dicebear.com/7.x/bottts/svg?seed=ai";
            document.getElementById('p1Label').innerText = "YOU";
            document.getElementById('p2Label').innerText = "AI BOT";
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameArea').style.display = 'flex';
            document.getElementById('scoreboard').classList.remove('hidden');
            localRoundLoop();
        }

        function localRoundLoop() {
            if (currentRound > 5) { showFinalScreen(); return; }
            setScreen("wait");
            setTimeout(() => {
                setScreen("go");
                window.goTime = Date.now();
                // AI Logic
                setTimeout(() => {
                    if (state === "go") {
                        state = "end"; setScreen("lose"); p2Score++; updateScoreUI();
                        currentRound++; setTimeout(localRoundLoop, 2000);
                    }
                }, Math.random() * 400 + 400);
            }, Math.random() * 2000 + 2000);
        }

        function localHandleTap() {
            if(state === "go") {
                state = "end"; setScreen("win"); p1Score++; updateScoreUI();
                currentRound++; setTimeout(localRoundLoop, 2000);
            } else if(state === "wait") {
                state = "end"; setScreen("lose"); p2Score++; updateScoreUI();
                currentRound++; setTimeout(localRoundLoop, 2000);
            }
        }

        // --- HELPERS ---
        function setScreen(mode) {
            state = mode;
            const msg = document.getElementById('gameMessage');
            const area = document.getElementById('gameArea');
            
            if (mode === "wait") {
                area.className = "bg-waiting"; msg.innerText = "WAIT"; 
                msg.classList.remove('text-white'); msg.classList.add('text-dark');
                canTap = true;
            } else if (mode === "go") {
                area.className = "bg-go"; msg.innerText = "TAP!"; 
                msg.classList.add('text-white');
            } else if (mode === "win") {
                area.className = "bg-win"; msg.innerText = "YOU WON!"; 
                msg.classList.add('text-white');
                canTap = false;
            } else if (mode === "lose") {
                area.className = "bg-lose"; msg.innerText = "YOU LOST"; 
                msg.classList.add('text-white');
                canTap = false;
            }
        }

        function updateScoreUI() {
            document.getElementById('scoreP1').innerText = p1Score;
            document.getElementById('scoreP2').innerText = p2Score;
            let displayRound = (currentRound > 5 ? 5 : currentRound);
            if(gameMode === "online" && state === "end") displayRound = currentRound - 1; // Correction
            document.getElementById('roundDisplay').innerText = displayRound + "/5";
        }

        function showFinalScreen() {
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('scoreboard').classList.add('hidden');
            document.getElementById('finalScreen').style.display = 'flex';
            document.getElementById('resultAvatar').src = myAvatar;
            
            let myFinalScore = (role === "guest" || gameMode === "local" && false) ? p2Score : p1Score; // Logic check
            if(role === "guest") myFinalScore = p2Score; else myFinalScore = p1Score; // Host or Local = P1
            
            let oppFinalScore = (role === "guest") ? p1Score : p2Score;
            
            const title = document.getElementById('finalTitle');
            if(myFinalScore > oppFinalScore) {
                title.innerText = "VICTORY!"; title.style.color = "var(--success)";
            } else if (myFinalScore < oppFinalScore) {
                title.innerText = "DEFEAT"; title.style.color = "var(--danger)";
            } else {
                title.innerText = "DRAW"; title.style.color = "#888";
            }
            document.getElementById('finalScoreText').innerText = `${myFinalScore} - ${oppFinalScore}`;
            
            document.getElementById('shareBtn').onclick = () => {
                window.open(`https://wa.me/?text=Neon Reflex Score: ${myFinalScore}-${oppFinalScore}`);
            };
        }
        
        function showWaiting() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('waitingUi').classList.remove('hidden');
            document.getElementById('roomCodeDisplay').innerText = roomId;
        }
        
        // Auto Code
        window.onload = () => {
             const params = new URLSearchParams(window.location.search);
             if(params.get('room')) document.getElementById('roomInput').value = params.get('room');
        };
    </script>
</body>
</html>
